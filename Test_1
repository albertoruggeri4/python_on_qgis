#TEST 1

import gdal
import os
import csv
import pandas
import glob 


os.chdir("D:/LAB2/Esame")



'''
Concatenare in un unico file tutti i csv 
stackoverflow.com/questions/53189427/how-to-open-multiple-csv-files-from-a-folder-in-python
'''

mycsvdir = 'csv'

csvfiles = glob.glob(os.path.join(mycsvdir, '*.csv'))

dataframes = []
for csvfile in csvfiles:
    df = pandas.read_csv(csvfile)
    dataframes.append(df)

result = pandas.concat(dataframes, ignore_index=True)

result.to_csv('all.csv', index=False)


def testing (dem, csv_file):
   csvfile_read = open(csv_all)
   reader = csv.DictReader(csvfile_read, delimiter=',')
   
   raster = gdal.Open(dem)
   gt = raster.GetGeoTransform()
   band = raster.GetRasterBand(1)
   arr = band.ReadAsArray()
   #print(arr)
   
   lista=[]
   for row in reader:
       
       list_row=[]
       
       utm_x = float(row['xcoord'])
       utm_y = float(row['ycoord'])
       px = int((utm_x-gt[0])/gt[1])
       py = int((utm_y - gt[3])/gt[5])
       #print(utm_x, utm_y) 
       #print(px,py)
       
       ### quota ###
       quota = band.ReadAsArray(px, py, 1, 1)
       quota_int = int(quota)
       #print(quota)
       
       
       #andiamo a creare la nuova lista
       list_row.append(row['COMUNE'])
       list_row.append(row['SHAPE_Leng'])
       list_row.append(row['SHAPE_Area'])
       list_row.append(row['xcoord'])
       list_row.append(row['ycoord'])
       list_row.append(quota_int)
       
       lista.append(list_row)
       #print(lista) #la lista di lista
    
    
    
    ### CREARE ADESSO IL NUOVO FILE CSV ###
    csv_out = open(csv_all.split('.')[0]+'_quota.csv','w')

    #adesso devo definire i campi
    fields = ['COMUNE','SHAPE_Leng','SHAPE_Area','xcoord','ycoord','quota']
    writer = csv.writer(csv_out)
    writer.writerow(fields)
    writer.writerows(lista)

    csvfile_read.close()
    csv_out.close()
    raster = None 

dem = 'dem_lombardia_100m_ED32N.tif'   
csv_all = 'all.csv'
testing (dem, csv_all)
